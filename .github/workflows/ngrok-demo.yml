name: Demo RAG App via Ngrok

jobs:
  deploy-ngrok-demo:
    runs-on: ubuntu-latest

    env:
      FASTAPI_PORT: 8000
      STREAMLIT_PORT: 8501
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ“¦ Install ngrok
      run: |
        curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
        echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
        sudo apt update && sudo apt install ngrok

    - name: ğŸ” Authenticate ngrok
      run: ngrok config add-authtoken "$NGROK_AUTH_TOKEN"

    - name: ğŸš€ Start FastAPI backend
      run: nohup uvicorn app:app --host 0.0.0.0 --port $FASTAPI_PORT &

    - name: ğŸŒ Start Streamlit frontend
      run: nohup streamlit run app_streamlit.py --server.port $STREAMLIT_PORT &

    - name: ğŸŒ Start ngrok for FastAPI
      run: |
        nohup ngrok http $FASTAPI_PORT > fastapi_ngrok.log &
        sleep 10
        cat fastapi_ngrok.log | grep "url=" || true

    - name: ğŸŒ Start ngrok for Streamlit
      run: |
        nohup ngrok http $STREAMLIT_PORT > streamlit_ngrok.log &
        sleep 10
        cat streamlit_ngrok.log | grep "url=" || true

    - name: ğŸ“ Keep job alive (6 hours)
      run: sleep 21600
